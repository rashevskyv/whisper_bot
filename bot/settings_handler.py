import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from .context_manager import context_manager

logger = logging.getLogger(__name__)

# –û–Ω–æ–≤–ª–µ–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
DEFAULT_SETTINGS = {
    'ENABLE_POSTPROCESSING': False,
    'ENABLE_SUMMARIZATION': True,
    'ENABLE_REWRITING': True,
    'ENABLE_VIDEO_PROCESSING': False,
    'ENABLE_VIDEO_NOTE_PROCESSING': True,
    'LANGUAGE': 'uk',
    'USE_GPT4': True,
    'CONTEXT_DURATION': 1,  # –≤ –≥–æ–¥–∏–Ω–∞—Ö
    'ENABLE_CONTEXT': True
}

def get_user_settings(context: ContextTypes.DEFAULT_TYPE, user_id: int):
    if 'user_settings' not in context.bot_data:
        context.bot_data['user_settings'] = {}
    if user_id not in context.bot_data['user_settings']:
        context.bot_data['user_settings'][user_id] = DEFAULT_SETTINGS.copy()
    return context.bot_data['user_settings'][user_id]

def update_user_setting(context: ContextTypes.DEFAULT_TYPE, user_id: int, setting: str, value):
    user_settings = get_user_settings(context, user_id)
    user_settings[setting] = value

async def settings_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    keyboard = [
        [InlineKeyboardButton("–û–±—Ä–æ–±–∫–∞ —Ç–µ–∫—Å—Ç—É", callback_data='text_processing')],
        [InlineKeyboardButton("–û–±—Ä–æ–±–∫–∞ –º–µ–¥—ñ–∞", callback_data='media_processing')],
        [InlineKeyboardButton("–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è AI", callback_data='ai_settings')],
        [InlineKeyboardButton("–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É", callback_data='context_settings')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    if update.callback_query:
        await update.callback_query.edit_message_text(text="–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å:", reply_markup=reply_markup)
    else:
        await update.message.reply_text("–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å:", reply_markup=reply_markup)

async def text_processing_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    user_settings = get_user_settings(context, user_id)
    
    keyboard = [
        [InlineKeyboardButton(
            f"–ü–æ—Å—Ç–æ–±—Ä–æ–±–∫–∞ {'‚úÖ' if user_settings['ENABLE_POSTPROCESSING'] else '‚ùå'}",
            callback_data='toggle_postprocessing')],
        [InlineKeyboardButton(
            f"–†–µ–∑—é–º—É–≤–∞–Ω–Ω—è {'‚úÖ' if user_settings['ENABLE_SUMMARIZATION'] else '‚ùå'}",
            callback_data='toggle_summarization')],
        [InlineKeyboardButton(
            f"–ü–µ—Ä–µ–ø–∏—Å—É–≤–∞–Ω–Ω—è {'‚úÖ' if user_settings['ENABLE_REWRITING'] else '‚ùå'}",
            callback_data='toggle_rewriting')],
        [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.callback_query.edit_message_text(text="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–∫–∏ —Ç–µ–∫—Å—Ç—É:", reply_markup=reply_markup)

async def media_processing_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    user_settings = get_user_settings(context, user_id)
    
    keyboard = [
        [InlineKeyboardButton(
            f"–û–±—Ä–æ–±–∫–∞ –≤—ñ–¥–µ–æ {'‚úÖ' if user_settings['ENABLE_VIDEO_PROCESSING'] else '‚ùå'}",
            callback_data='toggle_video_processing')],
        [InlineKeyboardButton(
            f"–û–±—Ä–æ–±–∫–∞ –≤—ñ–¥–µ–æ–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å {'‚úÖ' if user_settings['ENABLE_VIDEO_NOTE_PROCESSING'] else '‚ùå'}",
            callback_data='toggle_video_note_processing')],
        [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.callback_query.edit_message_text(text="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–∫–∏ –º–µ–¥—ñ–∞:", reply_markup=reply_markup)

async def ai_settings_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    user_settings = get_user_settings(context, user_id)
    
    keyboard = [
        [InlineKeyboardButton(
            f"–ú–æ–≤–∞: {'üá∫üá¶' if user_settings['LANGUAGE'] == 'uk' else 'üá¨üáß' if user_settings['LANGUAGE'] == 'en' else 'üá∑üá∫'}",
            callback_data='change_language')],
        [InlineKeyboardButton(
            f"AI: {'GPT-4' if user_settings['USE_GPT4'] else 'Claude'}",
            callback_data='toggle_ai')],
        [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.callback_query.edit_message_text(text="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è AI:", reply_markup=reply_markup)

async def context_settings_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    user_settings = get_user_settings(context, user_id)
    
    keyboard = [
        [InlineKeyboardButton(
            f"–ö–æ–Ω—Ç–µ–∫—Å—Ç {'‚úÖ' if user_settings['ENABLE_CONTEXT'] else '‚ùå'}",
            callback_data='toggle_context')],
        [InlineKeyboardButton(
            f"–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É: {user_settings['CONTEXT_DURATION']} –≥–æ–¥",
            callback_data='change_context_duration')],
        [InlineKeyboardButton("–°–∫–∏–Ω—É—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç", callback_data='reset_context')],
        [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.callback_query.edit_message_text(text="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É:", reply_markup=reply_markup)

async def toggle_setting(update: Update, context: ContextTypes.DEFAULT_TYPE, setting: str) -> None:
    user_id = update.effective_user.id
    user_settings = get_user_settings(context, user_id)
    user_settings[setting] = not user_settings[setting]
    logger.info(f"{setting} {'—É–≤—ñ–º–∫–Ω–µ–Ω–æ' if user_settings[setting] else '–≤–∏–º–∫–Ω–µ–Ω–æ'} –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {user_id}")
    await update.callback_query.answer(f"{setting} {'—É–≤—ñ–º–∫–Ω–µ–Ω–æ' if user_settings[setting] else '–≤–∏–º–∫–Ω–µ–Ω–æ'}")

async def toggle_postprocessing(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await toggle_setting(update, context, 'ENABLE_POSTPROCESSING')
    await text_processing_menu(update, context)

async def toggle_summarization(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await toggle_setting(update, context, 'ENABLE_SUMMARIZATION')
    await text_processing_menu(update, context)

async def toggle_rewriting(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await toggle_setting(update, context, 'ENABLE_REWRITING')
    await text_processing_menu(update, context)

async def toggle_video_processing(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await toggle_setting(update, context, 'ENABLE_VIDEO_PROCESSING')
    await media_processing_menu(update, context)

async def toggle_video_note_processing(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await toggle_setting(update, context, 'ENABLE_VIDEO_NOTE_PROCESSING')
    await media_processing_menu(update, context)

async def change_language(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    user_settings = get_user_settings(context, user_id)
    if user_settings['LANGUAGE'] == 'uk':
        user_settings['LANGUAGE'] = 'en'
        language_name = '–ê–Ω–≥–ª—ñ–π—Å—å–∫–∞'
    elif user_settings['LANGUAGE'] == 'en':
        user_settings['LANGUAGE'] = 'ru'
        language_name = '–†–æ—Å—ñ–π—Å—å–∫–∞'
    else:
        user_settings['LANGUAGE'] = 'uk'
        language_name = '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
    logger.info(f"–ú–æ–≤–∞ –∑–º—ñ–Ω–µ–Ω–∞ –Ω–∞ {user_settings['LANGUAGE']} –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {user_id}")
    await update.callback_query.answer(f"–ú–æ–≤–∞ –∑–º—ñ–Ω–µ–Ω–∞ –Ω–∞ {language_name}")
    await ai_settings_menu(update, context)

async def toggle_ai(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await toggle_setting(update, context, 'USE_GPT4')
    await ai_settings_menu(update, context)

async def toggle_context(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await toggle_setting(update, context, 'ENABLE_CONTEXT')
    user_id = update.effective_user.id
    user_settings = get_user_settings(context, user_id)
    if not user_settings['ENABLE_CONTEXT']:
        context_manager.clear_context(user_id)
    await context_settings_menu(update, context)

async def change_context_duration(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    user_settings = get_user_settings(context, user_id)
    durations = [1, 3, 6, 12, 24, 48, 72]
    current_index = durations.index(user_settings['CONTEXT_DURATION'])
    new_duration = durations[(current_index + 1) % len(durations)]
    user_settings['CONTEXT_DURATION'] = new_duration
    context_manager.set_context_duration(user_id, new_duration * 3600)  # –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≥–æ–¥–∏–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∏
    logger.info(f"–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –∑–º—ñ–Ω–µ–Ω–∞ –Ω–∞ {new_duration} –≥–æ–¥–∏–Ω –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {user_id}")
    await update.callback_query.answer(f"–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –∑–º—ñ–Ω–µ–Ω–∞ –Ω–∞ {new_duration} –≥–æ–¥–∏–Ω")
    await context_settings_menu(update, context)

async def reset_context(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    context_manager.clear_context(user_id)
    await update.callback_query.answer("–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–∫–∏–Ω—É—Ç–æ")
    await context_settings_menu(update, context)

# –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ –≤—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∞ –∑–º—ñ–Ω–Ω—ñ
__all__ = ['get_user_settings', 'update_user_setting', 'settings_menu', 'toggle_postprocessing', 
           'toggle_summarization', 'toggle_rewriting', 'toggle_video_processing', 
           'toggle_video_note_processing', 'change_language', 'toggle_ai', 'DEFAULT_SETTINGS',
           'toggle_context', 'change_context_duration', 'text_processing_menu', 'media_processing_menu',
           'ai_settings_menu', 'context_settings_menu', 'reset_context']